<mat-toolbar color="primary">
  <h1 mat-dialog-title>Select Exercise</h1>
  <button mat-icon-button type="button" (click)="dialogRef.close(null)" aria-label="Close">
    <mat-icon>close</mat-icon>
  </button>
</mat-toolbar>

<mat-dialog-content>
  <div class="filter-controls">
    <mat-form-field appearance="outline">
      <mat-label>Search</mat-label>
      <mat-icon matTextPrefix>search</mat-icon>
      <input
        matInput
        type="text"
        placeholder="Search for an exercise"
        [ngModel]="search()"
        (ngModelChange)="search.set($event)"
      />
      @if (search()) {
        <button matSuffix mat-icon-button (click)="search.set('')" aria-label="Clear search">
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Force</mat-label>
      <mat-select multiple [ngModel]="force()" (ngModelChange)="force.set($event)">
        <mat-option value="push">Push</mat-option>
        <mat-option value="pull">Pull</mat-option>
        <mat-option value="static">Static</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Level</mat-label>
      <mat-select multiple [ngModel]="level()" (ngModelChange)="level.set($event)">
        <mat-option value="beginner">Beginner</mat-option>
        <mat-option value="intermediate">Intermediate</mat-option>
        <mat-option value="expert">Expert</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Mechanic</mat-label>
      <mat-select multiple [ngModel]="mechanic()" (ngModelChange)="mechanic.set($event)">
        <mat-option value="isolation">Isolation</mat-option>
        <mat-option value="compound">Compound</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Equipment</mat-label>
      <mat-select multiple [ngModel]="equipment()" (ngModelChange)="equipment.set($event)">
        @for (option of equipmentOptions(); track option) {
        <mat-option [value]="option">{{ option }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Muscles</mat-label>
      <mat-select multiple [ngModel]="muscles()" (ngModelChange)="muscles.set($event)">
        @for (option of muscleOptions(); track option) {
        <mat-option [value]="option">{{ option }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Sort by</mat-label>
      <mat-select [ngModel]="sortBy()" (ngModelChange)="sortBy.set($event)">
        <mat-option value="name">Name</mat-option>
        <mat-option value="difficulty">Difficulty</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="filter-actions">
      <button mat-stroked-button (click)="clearFilters()">
        <mat-icon>clear_all</mat-icon>
        Clear Filters
      </button>
    </div>
  </div>

  <div class="exercise-results">
    <div class="results-header">
      <h3>{{ filteredExercises().length }} exercise(s) found</h3>
      @if (selectedExercise()) {
        <div class="selected-indicator">
          <mat-icon>check_circle</mat-icon>
          <span>{{ selectedExercise()!.name }} selected</span>
        </div>
      }
    </div>

    <cdk-virtual-scroll-viewport itemSize="140" class="exercise-grid">
      <div class="exercise-cards">
        @for (exercise of filteredExercises(); track trackByExerciseId($index, exercise)) {
          <mat-card 
            class="exercise-card"
            [class.selected]="isExerciseSelected(exercise)"
            (click)="selectExercise(exercise)"
            tabindex="0"
            (keydown.enter)="selectExercise(exercise)"
            (keydown.space)="selectExercise(exercise)"
            [attr.aria-label]="'Select ' + exercise.name"
          >
            @if (isExerciseSelected(exercise)) {
              <div class="selection-indicator">
                <mat-icon>check_circle</mat-icon>
              </div>
            }
            
            @if (exercise.images && exercise.images[0]) {
              <img 
                ngSrc="{{ getOptimizedExerciseImageUrl(exercise.images[0]) }}"
                [alt]="exercise.name"
                width="120"
                height="120"
                priority="false"
                loading="lazy"
                sizes="(max-width: 768px) 30vw, 15vw"
                class="exercise-image"
              />
            } @else {
              <div class="exercise-image-placeholder">
                <mat-icon>fitness_center</mat-icon>
              </div>
            }
            
            <mat-card-content>
              <h4 class="exercise-name">{{ exercise.name }}</h4>
              <div class="exercise-meta">
                <mat-chip-set>
                    @if (exercise.level) {
                    <mat-chip>{{ exercise.level }}</mat-chip>
                    }
                    @if (exercise.force) {
                    <mat-chip>{{ exercise.force }}</mat-chip>
                    }
                    @if (exercise.mechanic) {
                    <mat-chip>{{ exercise.mechanic }}</mat-chip>
                    }
                </mat-chip-set>
                <div class="exercise-details">
                  <span class="equipment">{{ exercise.equipment }}</span>
                  <span class="muscles">{{ exercise.primaryMuscles.slice(0, 2).join(', ') }}
                    @if (exercise.primaryMuscles.length > 2) {
                      <span class="more-muscles">+{{ exercise.primaryMuscles.length - 2 }} more</span>
                    }
                  </span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    </cdk-virtual-scroll-viewport>
  </div>
</mat-dialog-content>

<mat-dialog-actions>
  <button mat-button (click)="dialogRef.close(null)">Cancel</button>
  <button mat-stroked-button (click)="applyFiltersOnly()">Apply Filters Only</button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="applySelection()"
    [disabled]="!selectedExercise()"
  >
    Select Exercise
  </button>
</mat-dialog-actions>
